<%- include('partials/header') %>

<style>
  :root{ --bg:#f6f2ea; --card:#fff; --accent:#f97316; --muted:#6b7280; --shadow:0 12px 30px rgba(2,6,23,0.06); --radius:16px }
  body{ background:var(--bg) }
  .wrap{ max-width:960px; margin:28px auto; padding:18px; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial; color:#0f172a }
  .card{ background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,0.04) }
  h2{ margin:0 0 6px }
  .muted{ color:var(--muted) }
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:18px }
  .step{ display:flex; gap:12px; padding:10px 0; border-bottom:1px solid #f1efe9 }
  .dot{ width:14px; height:14px; border-radius:50%; background:#fde7d3; border:2px solid var(--accent); margin-top:4px }
  .status{ font-weight:700 }
  table{ width:100%; border-collapse:collapse; margin-top:10px }
  th,td{ padding:10px 8px; border-bottom:1px solid #f1efe9; text-align:left }
  .btn{ background:var(--accent); color:#071; border:none; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer; text-decoration:none; display:inline-block }
  .warn{ background:#fff3f2; border:1px solid rgba(176,11,11,0.08); padding:12px; border-radius:12px; color:#7b1d12 }
  @media (max-width: 720px){ .grid{ grid-template-columns: 1fr; } }
</style>

<div class="wrap">
  <div id="no-tracking" style="display:none">
    <div class="card warn">
      <div style="font-weight:800">No tracking data available.</div>
      <div class="muted">Complete a payment first to generate tracking.</div>
      <a class="btn" href="/payment" style="margin-top:10px;text-decoration:none">Go to Payment</a>
    </div>
  </div>

  <div id="tracking-card" class="card" style="display:none">
    <h2>Order Tracking</h2>
    <div class="muted" style="margin-bottom:10px">Track your Republic Surprise delivery status.</div>

    <div class="grid">
      <div>
        <div id="order-switcher" style="margin-bottom:10px; display:none;">
          <label for="order-select" style="font-weight:700;">Choose order</label>
          <select id="order-select" style="margin-left:8px; padding:6px 8px; border-radius:8px; border:1px solid rgba(0,0,0,0.15);"></select>
        </div>
        <div><strong>Order ID:</strong> <span id="order-id"></span></div>
        <div><strong>Invoice ID:</strong> <span id="invoice-id"></span></div>
        <div><strong>Placed:</strong> <span id="placed-at"></span></div>

        <div style="margin-top:14px">
          <div style="font-weight:700">Status</div>
          <div id="status-list"></div>
        </div>
      </div>

      <div>
        <div style="font-weight:700">Items</div>
        <table aria-label="Order items">
          <thead><tr><th>Item</th><th style="text-align:center">Qty</th><th style="text-align:right">Unit</th></tr></thead>
          <tbody id="items"></tbody>
        </table>
        <div id="ticket-card" class="card" style="display:none; margin-top:14px;">
          <div style="font-weight:700; margin-bottom:6px;">Refund request</div>
          <div><strong>Ticket ID:</strong> <span id="ticket-id"></span></div>
          <div><strong>Status:</strong> <span id="ticket-status"></span></div>
          <div><strong>Reason:</strong> <span id="ticket-reason"></span></div>
          <div><strong>Details:</strong> <span id="ticket-desc"></span></div>
          <div id="ticket-wallet-row" style="display:none;"><strong>Refunded Wallet:</strong> <span id="ticket-wallet"></span></div>
          <div id="ticket-resolved-row" style="display:none;"><strong>Resolved:</strong> <span id="ticket-resolved"></span></div>
          <div id="ticket-attachments" style="display:none; margin-top:8px;">
            <div style="font-weight:700; margin-bottom:6px;">Attachments</div>
            <div id="ticket-attachments-grid" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
          </div>
        </div>
        <div style="margin-top:12px">
          <a href="/shopping" class="btn" style="text-decoration:none">Back to Shop</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const TRACKING_KEY = 'ORDER_TRACKING_DATA';
  const CURRENT_WALLET = <%- JSON.stringify((user && user.walletAddress) ? user.walletAddress.toLowerCase() : '') %>;
  const $ = id => document.getElementById(id);
  function fmtSgd(n, rate){
    const value = Number(n) || 0;
    if (!rate) return 'S$' + value.toFixed(2);
    return 'S$' + (value * rate).toFixed(2);
  }

  function readTrackingList(){
    const raw = sessionStorage.getItem(TRACKING_KEY);
    if (!raw) return [];
    try {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) return parsed;
      if (parsed && typeof parsed === 'object') return [parsed];
      return [];
    } catch (e) {
      return [];
    }
  }

  function renderTracking(data){
    $('order-id').textContent = data.orderId || '';
    $('invoice-id').textContent = data.invoiceId || '';
    $('placed-at').textContent = data.placedAt || '';

    const statusList = $('status-list');
    statusList.innerHTML = '';
    (data.statusHistory || []).forEach(step => {
      const row = document.createElement('div');
      row.className = 'step';
      row.innerHTML = '<div class="dot"></div><div><div class="status">' + (step.label || '') + '</div><div class="muted">' + (step.time || '') + '</div></div>';
      statusList.appendChild(row);
    });

    const items = $('items');
    const totalEth = (data.items || []).reduce((sum, it) => {
      return sum + (Number(it.price || 0) * Number(it.qty || 0));
    }, 0);
    const rate = Number(data.sgdRate || 0) || ((Number(data.sgdTotal || 0) && totalEth) ? Number(data.sgdTotal) / totalEth : 0);
    items.innerHTML = '';
    (data.items || []).forEach(it => {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>' + (it.name || '') + '</td><td style="text-align:center">' + (it.qty || 0) + '</td><td style="text-align:right">' + fmtSgd(it.price || 0, rate) + '</td>';
      items.appendChild(tr);
    });

    const ticketCard = $('ticket-card');
    if (ticketCard && data.ticket && (data.ticket.status === 'Approved' || data.ticket.status === 'Rejected')) {
      $('ticket-id').textContent = data.ticket.id || '';
      $('ticket-status').textContent = data.ticket.status || '';
      $('ticket-reason').textContent = data.ticket.reason || '';
      $('ticket-desc').textContent = data.ticket.description || '-';
      const walletRow = $('ticket-wallet-row');
      if (data.ticket.refundedWallet) {
        $('ticket-wallet').textContent = data.ticket.refundedWallet;
        walletRow.style.display = 'block';
      } else {
        walletRow.style.display = 'none';
      }
      const resolvedRow = $('ticket-resolved-row');
      if (data.ticket.resolvedAt) {
        $('ticket-resolved').textContent = data.ticket.resolvedAt;
        resolvedRow.style.display = 'block';
      } else {
        resolvedRow.style.display = 'none';
      }
      const attachmentsWrap = $('ticket-attachments');
      const attachmentsGrid = $('ticket-attachments-grid');
      if (attachmentsWrap && attachmentsGrid) {
        attachmentsGrid.innerHTML = '';
        const files = Array.isArray(data.ticket.attachments) ? data.ticket.attachments : [];
        if (files.length) {
          files.forEach((file) => {
            if (!file || !file.data || !file.mimetype) return;
            const img = document.createElement('img');
            img.src = 'data:' + file.mimetype + ';base64,' + file.data;
            img.alt = file.name || 'Attachment';
            img.style.maxWidth = '180px';
            img.style.border = '1px solid #eee';
            img.style.borderRadius = '8px';
            img.style.padding = '6px';
            attachmentsGrid.appendChild(img);
          });
          attachmentsWrap.style.display = attachmentsGrid.childElementCount ? 'block' : 'none';
        } else {
          attachmentsWrap.style.display = 'none';
        }
      }
      ticketCard.style.display = 'block';
    } else if (ticketCard) {
      ticketCard.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const list = readTrackingList().filter(entry => {
      if (!CURRENT_WALLET) return true;
      const wallet = (entry.customerWallet || entry.wallet || '').toLowerCase();
      return wallet === CURRENT_WALLET;
    });
    if (!list.length) { $('no-tracking').style.display = 'block'; return; }

    const params = new URLSearchParams(window.location.search);
    const requested = params.get('orderId');
    let current = requested ? list.find(x => x && x.orderId === requested) : null;
    if (!current) current = list[list.length - 1];

    if (list.length > 1) {
      const switcher = $('order-switcher');
      const select = $('order-select');
      select.innerHTML = '';
      list.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.orderId || '';
        opt.textContent = item.orderId || 'Unknown order';
        if (item.orderId === current.orderId) opt.selected = true;
        select.appendChild(opt);
      });
      select.addEventListener('change', () => {
        const next = select.value;
        if (!next) return;
        const url = new URL(window.location.href);
        url.searchParams.set('orderId', next);
        window.location.href = url.toString();
      });
      switcher.style.display = 'block';
    }

    // Fetch live status from server to keep aligned with admin/delivery dashboards
    const injectLiveStatus = async () => {
      if (!current.orderId) return;
      try {
        const res = await fetch('/order-status/' + encodeURIComponent(current.orderId), { cache: 'no-store' });
        if (res.ok) {
          const body = await res.json();
          if (body?.success) {
            current.statusHistory = [{ label: body.statusLabel, time: body.updatedAt || current.placedAt }];
            if (body.ticket) {
              current.ticket = body.ticket;
            }
          }
        }
      } catch (e) { /* ignore */ }
    };

    injectLiveStatus().finally(() => {
      renderTracking(current);
      $('tracking-card').style.display = 'block';
    });
  });
})();
</script>

<%- include('partials/footer') %>
