<%- include('partials/header') %>

<style>
  :root{ --bg:#f6f2ea; --card:#fff; --accent:#f97316; --muted:#6b7280; --shadow:0 18px 40px rgba(2,6,23,0.08); --radius:16px }
  body{ background:var(--bg) }
  .wrap{ max-width:1100px; margin:28px auto; padding:24px; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial; color:#0f172a }
  .card{ background:var(--card); border-radius:var(--radius); padding:26px; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,0.04) }
  h1{ margin:0 0 8px; font-size:1.6rem }
  .muted{ color:var(--muted) }
  .invoice-grid{ display:flex; gap:18px; flex-wrap:wrap; align-items:flex-start }
  .col{ flex:1; min-width:260px }
  .meta{ display:flex; gap:12px; flex-wrap:wrap }
  table{ width:100%; border-collapse:collapse; margin-top:18px; font-size:0.98rem }
  th,td{ padding:12px 10px; border-bottom:1px solid #f1efe9; text-align:left }
  th{ color:var(--muted); font-weight:700; font-size:0.95rem }
  .total-line{ display:flex; justify-content:space-between; font-weight:800; margin-top:16px; font-size:1.05rem }
  .btn{ background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; text-decoration:none; display:inline-block }
  .small{ font-size:0.95rem; color:var(--muted) }
  .warn{ background:#fff3f2; border:1px solid rgba(176,11,11,0.08); padding:12px; border-radius:12px; color:#7b1d12 }
  .details{ background:#fbfaf7; border-radius:10px; padding:12px; border:1px solid rgba(0,0,0,0.03) }
  .meta-row{ margin-bottom:6px }

  @media print{
    body{ background:#fff }
    .btn, a.btn{ display:none !important }
    .wrap{ max-width:100%; margin:0; padding:0 }
    .card{ box-shadow:none; border:none; border-radius:0; padding:0 }
  }
</style>

<div class="wrap">
  <div id="no-invoice" style="display:none">
    <div class="card warn">
      <div style="font-weight:800">No invoice available.</div>
      <div class="small">No successful payment detected. Complete payment to view printable invoice.</div>
      <div style="margin-top:10px"><a class="btn" href="/cart">Back to Cart</a></div>
    </div>
  </div>

  <div id="card" style="display:none" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <h1>Invoice</h1>
        <div class="small muted">Official invoice — Republic Surprise</div>
      </div>
      <div style="text-align:right">
        <button id="print" class="btn">Print Invoice</button>
        <a href="/order-tracking" class="btn" style="margin-left:8px;text-decoration:none">Track Order</a>
      </div>
    </div>

    <div class="invoice-grid" style="margin-top:18px">
      <div class="col details">
        <div class="meta-row"><strong>Invoice ID:</strong> <span id="id"></span></div>
        <div class="meta-row"><strong>Order ID:</strong> <span id="orderId"></span></div>
        <div class="meta-row"><strong>Date:</strong> <span id="date"></span></div>
      </div>

      <div class="col details">
        <div class="meta-row"><strong>Username:</strong> <span id="username"></span></div>
        <div class="meta-row"><strong>Buyer wallet:</strong> <span id="buyer"></span></div>
        <div class="meta-row"><strong>Contact:</strong> <span id="contact"></span></div>
        <div class="meta-row"><strong>Merchant:</strong> <span id="merchant"></span></div>
      </div>

      <div class="col details">
        <div class="meta-row"><strong>Payment:</strong> <span id="payMethod"></span></div>
        <div class="meta-row"><strong>Payment status:</strong> <span id="payStatus"></span></div>
        <div class="meta-row"><strong>Transaction:</strong> <a id="tx" href="#" target="_blank" rel="noreferrer"></a></div>
      </div>
    </div>

    <div class="card" id="addresses" style="margin-top:16px;padding:12px">
      <div style="display:flex;gap:18px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px"><strong>Shipping Address</strong><div id="shipping" class="small muted"></div></div>
        <div style="flex:1;min-width:260px"><strong>Billing Address</strong><div id="billing" class="small muted"></div></div>
      </div>
    </div>

    <table aria-label="Invoice items">
      <thead>
        <tr>
          <th>Item</th>
          <th style="text-align:center">Qty</th>
          <th style="text-align:right">Unit</th>
          <th style="text-align:right">Subtotal</th>
        </tr>
      </thead>
      <tbody id="items"></tbody>
    </table>

    <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:10px;align-items:center">
      <div style="width:320px">
        <div class="small" style="display:flex;justify-content:space-between"><div>Subtotal</div><div id="subtotalVal">S$0.00</div></div>
        <div class="small" style="display:flex;justify-content:space-between"><div>Shipping</div><div id="shippingVal">S$0.00</div></div>
        <div class="small" style="display:flex;justify-content:space-between"><div>Tax</div><div id="taxVal">S$0.00</div></div>
        <div class="total-line"><div>Total (SGD)</div><div id="total"><strong>S$0.00</strong></div></div>
      </div>
    </div>

    <div style="margin-top:14px"><a href="/shopping" class="btn" style="text-decoration:none">Back to Shop</a></div>
  </div>
</div>

<script>
(() => {
  const KEYS = ['INVOICE_DATA','FA_INVOICE_DATA','PAYMENT_RESULT','ORDER_RESULT'];
  const TRACKING_KEY = 'ORDER_TRACKING_DATA';
  const $ = id => document.getElementById(id);
  const SERVER_CUSTOMER_CONTACT = <%- JSON.stringify((user && user.contact) ? user.contact : '') %>;
  const SERVER_CUSTOMER_NAME = <%- JSON.stringify((user && user.name) ? user.name : '') %>;
  function esc(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
  function fmtSgd(n){ return 'S$' + (Number(n) || 0).toFixed(2); }

  function isPaymentSuccessful(inv){
    if(!inv) return false;
    const okStates = ['paid','success','confirmed'];
    if(inv.success === true) return true;
    if(inv.paid === true) return true;
    if(inv.paymentStatus && okStates.includes(String(inv.paymentStatus).toLowerCase())) return true;
    if(inv.status && okStates.includes(String(inv.status).toLowerCase())) return true;
    if(inv.txHash) return true; // treat tx presence as success
    // Accept invoices produced by the local payment flow (payment.ejs)
    if(inv.invoiceId) return true;
    if(typeof inv.total === 'number' && Number(inv.total) > 0) return true;
    if(typeof inv.sgdTotal === 'number' && Number(inv.sgdTotal) > 0) return true;
    if(Array.isArray(inv.items) && inv.items.length > 0) return true;
    return false;
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    let raw = null;
    for(const k of KEYS){ const v = sessionStorage.getItem(k); if(v){ raw = v; break; } }
    if(!raw){ $('no-invoice').style.display = 'block'; return; }
    let inv = null;
    try{ inv = JSON.parse(raw); }catch(e){ $('no-invoice').style.display = 'block'; return; }

    if(!isPaymentSuccessful(inv)){
      $('no-invoice').style.display = 'block';
      return;
    }

    $('id').textContent = inv.invoiceId || inv.invoice_id || '';
    // Ensure a fresh order ID is created for each successful transaction
    const newOrderId = 'ORD-' + Date.now() + '-' + (Math.floor(Math.random()*9000)+1000);
    inv.orderId = inv.orderId || inv.order_id || newOrderId;
    $('orderId').textContent = inv.orderId;
    $('date').textContent = inv.dateTime || inv.date || new Date().toLocaleString();
    // Username (prefer invoice, then server session, then invoice name fields)
    $('username').textContent = inv.username || inv.name || SERVER_CUSTOMER_NAME || '';
    $('buyer').textContent = inv.wallet || inv.buyerAddress || inv.buyer || '';
    $('merchant').textContent = inv.merchantAddress || inv.merchant || 'Republic Surprise';
    // Prefer contact from invoice, then server-rendered user contact, then any email field
    $('contact').textContent = inv.contact || SERVER_CUSTOMER_CONTACT || inv.email || '';
    // Payment method — this app uses MetaMask for payments
    $('payMethod').textContent = 'MetaMask';
    const payStatus = inv.paymentStatus || inv.status || (inv.paid? 'paid' : '');
    $('payStatus').textContent = payStatus || 'Confirmed';

    const txEl = $('tx');
    // If a blockchain tx hash exists, show link; otherwise show the completed product price as the "transaction" value
    if(inv.txHash){ txEl.textContent = inv.txHash; txEl.href = 'https://etherscan.io/tx/' + inv.txHash; }
    else {
      const price = Number(inv.sgdTotal || inv.total || inv.totalPaid || inv.totalPaidEth || 0) || 0;
      txEl.textContent = fmtSgd(price);
      txEl.removeAttribute('href');
    }

    // Addresses
    const ship = inv.shippingAddress || inv.shipping || inv.ship || '';
    const bill = inv.billingAddress || inv.billing || inv.bill || ship || '';
    $('shipping').textContent = (typeof ship === 'string') ? ship : JSON.stringify(ship);
    $('billing').textContent = (typeof bill === 'string') ? bill : JSON.stringify(bill);

    // Items
    const body = $('items'); body.innerHTML = '';
    let subtotal = 0;
    let shippingVal = Number(inv.shipping || inv.shippingCost || inv.shippingVal || 0) || 0;
    let taxVal = Number(inv.tax || inv.taxAmount || 0) || 0;

    (inv.items || []).forEach(it => {
      const tr = document.createElement('tr');
      const unit = Number(it.price) || Number(it.unitPrice) || 0;
      const qty = Number(it.qty) || Number(it.quantity) || 0;
      const lineSubtotal = unit * (qty || 1);
      const desc = it.description ? ('<div class="small muted">'+esc(it.description)+'</div>') : '';
      tr.innerHTML = '<td>'+esc(it.name || it.title || 'Item')+desc+'</td><td style="text-align:center">'+(qty||1)+'</td><td style="text-align:right">'+fmtSgd(unit)+'</td><td style="text-align:right">'+fmtSgd(lineSubtotal)+'</td>';
      body.appendChild(tr);
      // Treat shipping as a separate line: do not include in subtotal
      const nm = String(it.name || it.title || '').toLowerCase();
      const isShipping = (it.id === 'shipping') || nm.includes('shipping');
      if (isShipping) {
        // prefer explicit shipping price; fallback to line subtotal
        shippingVal = (Number(it.price) || Number(it.unitPrice) || 0) || lineSubtotal || shippingVal;
      } else {
        subtotal += lineSubtotal;
      }
    });

    // If shipping isn't provided but there are items, apply default shipping cost
    if ((!shippingVal || shippingVal === 0) && subtotal > 0) {
      shippingVal = 6.9; // default shipping
    }

    // fallback totals (use provided totals if present, otherwise compute)
    const totalVal = Number(inv.sgdTotal || inv.total || inv.totalPaid || inv.totalPaidEth || (subtotal + shippingVal + taxVal)) || (subtotal + shippingVal + taxVal);
    $('subtotalVal').textContent = fmtSgd(subtotal);
    $('shippingVal').textContent = fmtSgd(shippingVal);
    $('taxVal').textContent = fmtSgd(taxVal);
    $('total').textContent = fmtSgd(totalVal);

    $('card').style.display = 'block';

    // If contact or username still empty, try fetching the user's profile page
    try {
      const needContact = (!$('contact').textContent || $('contact').textContent.trim() === '');
      const needName = (!$('username').textContent || $('username').textContent.trim() === '');
      if (needContact || needName) {
        fetch('/user/profile', { cache: 'no-store' }).then(async (res)=>{
          if(!res.ok) return;
          const txt = await res.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(txt, 'text/html');

          // Try to extract contact/phone
          if (needContact) {
            const contactInput = doc.querySelector('input#contact, input[name="contact"], input[name="phone"], input[name="telephone"]');
            if(contactInput && contactInput.value){
              $('contact').textContent = contactInput.value;
              try{ inv.contact = contactInput.value; }catch(e){}
            }
          }

          // Try to extract registered name for Username
          if (needName) {
            const nameInput = doc.querySelector('input#name, input[name="name"], input#username, input[name="username"], input[name="fullName"], input[name="fullname"], input[name="firstName"]');
            let nameVal = '';
            if (nameInput && nameInput.value) nameVal = nameInput.value.trim();
            if (!nameVal) {
              const possible = doc.querySelector('.user-name, .username, #profileName, .profile-name, h1');
              if (possible) nameVal = possible.textContent.trim();
            }
            if (nameVal) {
              $('username').textContent = nameVal;
              try{ inv.username = nameVal; }catch(e){}
            }
          }

          // persist any changes made
          try{ sessionStorage.setItem('INVOICE_DATA', JSON.stringify(inv)); }catch(e){}
        }).catch(()=>{});
      }
    } catch(e) { /* ignore */ }

    // create or update tracking entry (ensure orderId persisted)
    try {
      const placedAt = inv.dateTime || new Date().toLocaleString();
      const tracking = JSON.parse(sessionStorage.getItem(TRACKING_KEY) || 'null') || {
        orderId: inv.orderId,
        invoiceId: inv.invoiceId || '',
        placedAt,
        items: inv.items || [],
        statusHistory: [
          { label: 'Payment confirmed', time: placedAt },
          { label: 'Order packed', time: 'Pending' },
          { label: 'Out for delivery', time: 'Pending' },
          { label: 'Delivered', time: 'Pending' }
        ],
        sgdTotal: inv.sgdTotal || inv.total || 0
      };
      tracking.orderId = inv.orderId;
      tracking.invoiceId = inv.invoiceId || tracking.invoiceId;
      tracking.items = inv.items || tracking.items;
      tracking.sgdTotal = inv.sgdTotal || inv.total || tracking.sgdTotal;
      sessionStorage.setItem(TRACKING_KEY, JSON.stringify(tracking));
    } catch(e) { /* ignore */ }

    // persist updated invoice data (with orderId/contact) back to storage
    try { sessionStorage.setItem('INVOICE_DATA', JSON.stringify(inv)); } catch(e) { /* ignore */ }

    $('print').addEventListener('click', ()=> window.print());
  });
})();
</script>

<%- include('partials/footer') %>
