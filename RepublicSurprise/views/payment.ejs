<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment</title>

  <style>
    :root{
      --bgA:#fde7c7;
      --bgB:#d9f6d6;
      --card:#ffffff;
      --soft:#fff7ef;
      --border:rgba(0,0,0,0.06);
      --text:#0f172a;
      --muted:#64748b;
      --accent:#f97316;
      --shadow: 0 12px 30px rgba(2,6,23,0.08);
      --radius:22px;
    }

    html, body { margin:0; padding:0; }

    
    body{
      background:#ffffff;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color: var(--text);
    }

    
    header{
      background:#ffffff;              
      padding: 14px 18px ;   
    }
    header h2{
      font-size: 22px ;      
    }
    header nav a{
      font-size: 14px ;     
      padding: 6px 4px;
    }
    header form button{
      padding: 10px 14px ;   
      border-radius: 12px ;
    }

    
    .page-bg{
      min-height: calc(100vh - 0px);
      background: linear-gradient(90deg, var(--bgA), var(--bgB));
      padding: 46px 0 90px;
    }

    .page-wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 0 16px;
    }

    .center-card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.04);
      padding: 26px 26px 22px;
    }

    .title{
      text-align:center;
      font-size: 34px;
      margin: 4px 0 8px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .subtitle{
      text-align:center;
      color: var(--muted);
      margin: 0 0 18px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(249,115,22,0.18);
      background: rgba(249,115,22,0.08);
      color: #b45309;
      font-weight: 800;
      font-size: 13px;
      margin: 0 auto 18px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 16px;
      margin-top: 6px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .box{
      border: 1px solid var(--border);
      border-radius: 18px;
      background: #fff;
      padding: 16px;
    }

    .box h3, .box h4{
      margin: 0 0 10px;
      font-size: 16px;
      font-weight: 900;
    }

    .muted{ color: var(--muted); }
    .small{ font-size: 14px; }

    .order-row{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    .order-row:last-child{ border-bottom: none; }

    .total-row{
      display:flex;
      justify-content: space-between;
      font-weight: 900;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(0,0,0,0.06);
    }

    .wallet-panel{
      background: var(--soft);
      border: 1px solid rgba(249,115,22,0.14);
      border-radius: 18px;
      padding: 14px;
      margin-top: 12px;
    }

    .btn{
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 900;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .btnPrimary{ background: var(--accent); color: #111; }
    .btnPrimary:hover{ filter: brightness(.98); }
    .btnConfirm{ background: #fbbf24; color:#111; }
    .btnGrey{ background:#e6e6e6; color:#111; }

    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    #status{
      margin-top: 10px;
      color: var(--muted);
    }

    .invoice-card{
      margin-top: 16px;
    }

    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }
    th, td{
      padding: 10px 8px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      text-align:left;
    }
    th{
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .right{ text-align:right; }
    code{ font-size: 12px; }

    
    footer{
      text-align:center !important;
      padding: 12px 0 !important;
      background:#ffffff; 
    }
  </style>
</head>

<body>
  <%- include('partials/header') %>

  <div class="page-bg">
    <div class="page-wrap">
      <div class="center-card">
        <div class="title">Payment</div>
        <div class="subtitle">Demo MetaMask flow â€” frontend only.</div>
        <div style="display:flex;justify-content:center;">
          <div class="pill">âœ¨ Transparent from order to delivery</div>
        </div>

        <div id="app">
          <div class="grid">
            <div class="box" id="payment-card">
              <h3>Order</h3>
              <div id="items-list" class="small muted" style="margin-bottom:10px"></div>

              <div class="total-row">
                <div>Total</div>
                <div id="total-amt">S$0.00</div>
              </div>

              <div class="wallet-panel">
                <div class="small" style="margin-bottom:10px;">
                  Wallet: <strong id="wallet">Not connected</strong>
                </div>

                <div id="wallet-actions">
                  <button id="btnConnect" class="btn btnPrimary">ðŸ”— Connect Wallet (MetaMask)</button>
                  <button id="btnConfirm" class="btn btnConfirm" disabled style="margin-left:8px;">âœ… Confirm Payment</button>
                  <!-- View Invoice link removed from wallet panel â€” inline invoice will display after payment -->
                </div>

                <div class="small" id="status"></div>
              </div>
            </div>

            <div class="box">
              <h4>Invoice Preview</h4>
              <div id="invoice-preview" class="small muted">
                Not generated yet. After confirming payment, a printable invoice will appear here.
              </div>
            </div>
          </div>

          <div id="invoice" class="box invoice-card" style="display:none">
            <h3>Invoice</h3>
            <div class="small muted">Receipt for your demo purchase</div>

            <div class="small" style="margin-top:10px;">
              <div style="margin:6px 0;">Invoice ID: <strong id="inv-id"></strong></div>
              <div style="margin:6px 0;">Date: <span id="inv-date"></span></div>
              <div style="margin:6px 0;">Wallet: <code id="inv-wallet"></code></div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="right">Qty</th>
                  <th class="right">Unit</th>
                  <th class="right">Subtotal</th>
                </tr>
              </thead>
              <tbody id="inv-items"></tbody>
            </table>

            <div class="total-row">
              <div>Total</div>
              <div id="inv-total"></div>
            </div>

            <div style="margin-top:12px;">
              <button id="printBtn" class="btn btnPrimary">ðŸ–¨ Print Payment</button>
              <a href="/order-tracking" class="btn btnPrimary" style="margin-left:8px;text-decoration:none;">Track Order</a>
              <a href="/invoice" class="btn btnPrimary" style="margin-left:8px;text-decoration:none;">View Invoice</a>
              <button id="backBtn" class="btn btnGrey" style="margin-left:8px;">Back</button>
              
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
  (() => {
    const CHECKOUT_KEY = 'CHECKOUT_DATA';
    const ALT_KEY = 'FA_CART_CHECKOUT_DATA';
    const INVOICE_KEY = 'INVOICE_DATA';
    const TRACKING_KEY = 'ORDER_TRACKING_DATA';
    const COINGECKO_URL = 'https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=sgd';
    const SERVER_CUSTOMER_NAME = <%- JSON.stringify((user && user.name) ? user.name : '') %>;
    const SERVER_CUSTOMER_ADDRESS = <%- JSON.stringify((user && user.address) ? user.address : '') %>;
    const SERVER_CUSTOMER_CONTACT = <%- JSON.stringify((user && user.contact) ? user.contact : '') %>;

    const $ = id => document.getElementById(id);

    function fmtSgd(n){
      // Treat the input number as an SGD amount (cart prices are stored in SGD)
      const num = Number(n) || 0;
      return 'S$' + num.toFixed(2);
    }

    async function fetchRate(){
      try{
        const res = await fetch(COINGECKO_URL);
        if(!res.ok) throw new Error('Rate fetch failed');
        const body = await res.json();
        const r = body && body.ethereum && body.ethereum.sgd ? Number(body.ethereum.sgd) : 0;
        window.ETH_SGD_RATE = r;
        return r;
      }catch(e){
        console.warn('Failed to fetch ETHâ†’SGD rate', e);
        window.ETH_SGD_RATE = 0;
        return 0;
      }
    }

    async function loadCheckout(){
      const raw = sessionStorage.getItem(CHECKOUT_KEY) || sessionStorage.getItem(ALT_KEY);
      if(raw){ try{ return JSON.parse(raw); }catch(e){} }

      // Try to fetch cart HTML from server and parse items (no server changes required)
      try{
        const res = await fetch('/cart', { cache: 'no-store' });
        if(res && res.ok){
          const text = await res.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(text, 'text/html');
          const items = [];
          doc.querySelectorAll('.item').forEach(node => {
            const name = (node.querySelector('h3')?.textContent || '').trim();
            const priceTextRaw = (node.querySelector('.meta')?.textContent || '').replace('S$', '').trim();
            const priceNumText = priceTextRaw.replace(/[^0-9\.]/g, '');
            const price = Number(priceNumText) || 0;
            const qtyInput = node.querySelector('input[name=qty]');
            const qty = Number(qtyInput?.value) || 1;
            const idInput = node.querySelector('input[name=id]');
            const id = idInput?.value || '';
            items.push({ id, name, price, qty, description: '' });
          });

          // parse subtotal / shipping / total from summary lines
          let subtotal = 0, shipping = 0, total = 0;
          doc.querySelectorAll('.summary-line').forEach(line => {
            const key = (line.querySelector('span')?.textContent || '').trim().toLowerCase();
            const valText = (line.querySelectorAll('span')[1]?.textContent || '').replace('S$', '').trim();
            const num = Number(valText.replace(/[^0-9\.]/g, '')) || 0;
            if(key.includes('subtotal')) subtotal = num;
            else if(key.includes('shipping')) shipping = num;
          });
          const totalEl = doc.querySelector('.summary-total span:last-child');
          if(totalEl){ total = Number((totalEl.textContent || '').replace(/[^0-9\.]/g, '')) || (subtotal + shipping); }
          else { total = items.reduce((s,i)=>s + (Number(i.price)||0) * (Number(i.qty)||0), 0) + shipping; }

          // Fallback: if subtotal/shipping weren't parsed but items exist, compute them like server does
          if((!subtotal || subtotal === 0) && items.length){
            subtotal = items.reduce((s,i)=>s + (Number(i.price)||0) * (Number(i.qty)||0), 0);
            shipping = subtotal > 0 ? 6.9 : 0;
            total = subtotal + shipping;
          }

          const checkout = { items, subtotal, shipping, total };
          try{ sessionStorage.setItem(CHECKOUT_KEY, JSON.stringify(checkout)); }catch(e){}
          return checkout;
        }
      }catch(e){ /* ignore and fall back */ }

      return { items: [{ name: 'Demo Surprise Box', qty: 1, price: 0.01, description: '' }], total: 0.01 };
    }

    const SHIPPING_DESC = 'Standard shipping (3-5 days)';

    function renderOrder(chk){
      const list = $('items-list'); list.innerHTML = '';
      (chk.items || []).forEach((i, idx) => {
        const div = document.createElement('div');
        div.className = 'order-row';
        const shippingHtml = (idx === 0 && chk.shipping && Number(chk.shipping) > 0)
          ? `<div class="muted small">Shipping - ${fmtSgd(chk.shipping)}</div>`
          : '';
        div.innerHTML = `
          <div style="flex:1">
            <div>${i.name}</div>
            ${i.description ? `<div class="muted small">${i.description}</div>` : ''}
            ${shippingHtml}
          </div>
          <div style="width:60px;text-align:center">${i.qty}</div>
          <div style="width:120px;text-align:right">${fmtSgd(i.price)}</div>
        `;
        list.appendChild(div);
      });
      $('total-amt').textContent = fmtSgd(chk.total || 0);
      $('invoice-preview').textContent =
        `Items: ${(chk.items||[]).map(x=>x.name).join(', ')} â€” Total ${fmtSgd(chk.total||0)}`;
    }

    async function connectWallet(){
      if(!window.ethereum){ throw new Error('MetaMask not detected'); }
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      return accounts && accounts[0];
    }

    const checkoutPromise = loadCheckout();

    // fetch rate first, then render order so SGD values are shown when available
    fetchRate().then(rate => {
      if(rate) $('status').textContent = 'Exchange rate loaded';
      checkoutPromise.then(async (chk) => {
        // fetch product descriptions (if possible) from product pages
        const descPromises = (chk.items || []).map(async (it) => {
          if(!it.description && it.id) {
            try{
              const r = await fetch('/product?id=' + encodeURIComponent(it.id), { cache: 'no-store' });
              if(r && r.ok){
                const t = await r.text();
                const p = new DOMParser().parseFromString(t, 'text/html');
                const desc = p.querySelector('.desc')?.textContent?.trim() || '';
                it.description = desc;
              }
            }catch(e){}
          }
        });
        await Promise.all(descPromises);
        renderOrder(chk);
        window.__checkout = chk;
      }).catch((e)=>{ renderOrder({ items: [], total: 0 }); });
    }).catch(()=> {
      checkoutPromise.then((chk)=>{ renderOrder(chk); window.__checkout = chk; }).catch(()=>renderOrder({ items: [], total: 0 }));
    });

    let connected = null;

    $('btnConnect').addEventListener('click', async ()=>{
      try{
        $('status').textContent = 'Requesting wallet...';
        const acc = await connectWallet();
        connected = acc;
        $('wallet').textContent = acc ? (acc.slice(0,6)+'...'+acc.slice(-4)) : 'Connected';
        $('status').textContent = acc ? 'Wallet connected' : '';
        $('btnConfirm').disabled = false;
      }catch(err){
        $('status').textContent = err && err.message ? err.message : String(err);
        if(String(err).toLowerCase().includes('user rejected')) $('status').textContent = 'Connection request rejected';
      }
    });

    // The View Invoice link was removed from the wallet panel; inline invoice will be shown after payment.

    $('btnConfirm').addEventListener('click', async ()=>{
      $('status').textContent = 'Processing payment...';
      $('btnConfirm').disabled = true; $('btnConnect').disabled = true;
      const chk = window.__checkout || await checkoutPromise.catch(()=>({ items: [], total: 0 }));
      setTimeout(()=>{
        $('status').textContent = 'Payment successful (simulated)';
        // show the inline invoice (no auto-redirect)
        showInvoice(connected, chk);
      }, 900);
    });
    

    function showInvoice(account, chk){
      const inv = {
        invoiceId: 'INV-'+Date.now(),
        dateTime: new Date().toLocaleString(),
        wallet: account || 'N/A',
        items: chk.items ? [...chk.items] : [],
        total: chk.total || 0,
        sgdTotal: (chk.total || 0)
      };

      $('inv-id').textContent = inv.invoiceId;
      $('inv-date').textContent = inv.dateTime;
      $('inv-wallet').textContent = inv.wallet;

      const tbody = $('inv-items'); tbody.innerHTML = '';
      // include shipping as an invoice line
      if(chk.shipping && Number(chk.shipping) > 0){
        inv.items.push({ id: 'shipping', name: 'Shipping', description: SHIPPING_DESC, price: chk.shipping, qty: 1 });
      }

      inv.items.forEach(it => {
        const tr = document.createElement('tr');
        const subtotal = (Number(it.price)||0) * (Number(it.qty)||0);
        tr.innerHTML = `
          <td>${it.name}${it.description ? `<div class="muted small">${it.description}</div>` : ''}</td>
          <td class="right">${it.qty}</td>
          <td class="right">${fmtSgd(it.price)}</td>
          <td class="right">${fmtSgd(subtotal)}</td>
        `;
        tbody.appendChild(tr);
      });
      $('inv-total').textContent = fmtSgd(inv.total);

      try{ sessionStorage.setItem(INVOICE_KEY, JSON.stringify(inv)); }catch(e){}

      const tracking = {
        orderId: 'ORD-' + Date.now(),
        invoiceId: inv.invoiceId,
        placedAt: inv.dateTime,
        items: inv.items || [],
        statusHistory: [
          { label: 'Payment confirmed', time: inv.dateTime },
          { label: 'Order packed', time: 'Pending' },
          { label: 'Out for delivery', time: 'Pending' },
          { label: 'Delivered', time: 'Pending' }
        ],
        sgdTotal: inv.sgdTotal
      };
      // persist tracking and notify server to create a delivery record
      try{ sessionStorage.setItem(TRACKING_KEY, JSON.stringify(tracking)); }catch(e){}

      // create delivery record for delivery staff â€” do not redirect the paying user
      const payload = {
        orderId: tracking.orderId,
        customerName: SERVER_CUSTOMER_NAME || inv.wallet,
        address: SERVER_CUSTOMER_ADDRESS || '',
        contact: SERVER_CUSTOMER_CONTACT || '',
        customerWallet: account || '',
        items: chk.items || [],
        total: chk.total || 0
      };
      fetch('/create-delivery', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(async (res) => {
        try{ const body = await res.json(); console.log('delivery created', body); }catch(e){ console.warn(e); }
      }).catch((err) => {
        console.warn('Failed to create delivery record', err);
      });

      const orderPayload = {
        orderId: tracking.orderId,
        customerWallet: account || '',
        customerName: SERVER_CUSTOMER_NAME || inv.wallet,
        contact: SERVER_CUSTOMER_CONTACT || '',
        product: (chk.items || []).map((it) => it.name).filter(Boolean).join(' + ') || 'Mystery Items',
        price: chk.total || 0,
        qty: (chk.items || []).reduce((sum, it) => sum + (Number(it.qty) || 0), 0) || 1,
        status: 'Pending Delivery Confirmation'
      };
      fetch('/create-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderPayload)
      }).then(async (res) => {
        try { const body = await res.json(); console.log('order created', body); } catch (e) { console.warn(e); }
      }).catch((err) => {
        console.warn('Failed to create order record', err);
      });

      // show invoice for a brief moment until redirect triggers
      $('invoice').style.display = 'block';
      $('payment-card').style.display = 'none';
      $('invoice-preview').textContent = 'Invoice ready';
    }

    $('printBtn').addEventListener('click', ()=> window.print());
    $('backBtn').addEventListener('click', ()=>{
      $('invoice').style.display = 'none';
      $('payment-card').style.display = 'block';
      $('btnConfirm').disabled = false;
      $('btnConnect').disabled = false;
    });
  })();
  </script>

  <%- include('partials/footer') %>
</body>
</html>
